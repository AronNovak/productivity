"use strict";angular.module("clientApp",["ngAnimate","ngCookies","ngSanitize","config","LocalStorageModule","ui.bootstrap","ui.router"]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(a,b,c){var d=["$state","Auth","$timeout",function(a,b,c){b.isAuthenticated()||c(function(){a.go("403")})}];a.state("homepage",{url:"/",controller:"HomepageCtrl",resolve:{account:["Account",function(a){return a.get()}]}}).state("login",{url:"/login",templateUrl:"views/login.html",controller:"LoginCtrl"}).state("dashboard",{"abstract":!0,url:"",templateUrl:"views/dashboard/main.html",controller:"DashboardCtrl",onEnter:d,resolve:{account:["Account",function(a){return a.get()}]}}).state("dashboard.tracking-form",{url:"/tracking/{username:string}/{year:int}/{month:int}/{day:string}/{id:string}",templateUrl:"views/dashboard/tracking-form.html",controller:"TrackingFormCtrl",onEnter:d,resolve:{projects:["$stateParams","Projects",function(a,b){return b.get(a.year,a.month)}],tracking:["$stateParams","Tracking",function(a,b){return b.get(a.year,a.month,a.username)}]}}).state("dashboard.tracking",{url:"/tracking/{year:int}/{month:int}",templateUrl:"views/dashboard/tracking.html",controller:"TrackingCtrl",onEnter:d}).state("dashboard.tracking-table",{url:"/tracking-table/{year:int}/{month:int}",templateUrl:"views/dashboard/tracking-table.html",controller:"TrackingTableCtrl",onEnter:d,resolve:{tracking:["$stateParams","Tracking",function(a,b){return b.get(a.year,a.month)}],trackingProject:["$stateParams","TrackingProject",function(a,b){return b.get(a.year,a.month)}]}}).state("dashboard.tracking.track",{url:"/tracking-table/{trackId:int}",templateUrl:"views/dashboard/tracking-table.html",controller:"TrackingCtrl",onEnter:d,resolve:{tracking:["$stateParams","Tracking",function(a,b){return b.get(a.year,a.month)}]}}).state("dashboard.account",{url:"/my-account",templateUrl:"views/dashboard/account/account.html",controller:"AccountCtrl",onEnter:d,resolve:{account:["Account",function(a){return a.get()}]}}).state("403",{url:"/403",templateUrl:"views/403.html"}),b.otherwise("/"),c.interceptors.push(["$q","Auth","localStorageService",function(a,b,c){return{request:function(a){return a.url.match(/login-token/)||(a.headers={"access-token":c.get("access_token")}),a},response:function(a){return a.data.access_token&&c.set("access_token",a.data.access_token),a},responseError:function(c){return 401===c.status&&b.authFailed(),a.reject(c)}}}])}]).run(["$rootScope","$state","$stateParams","$log","Config",function(a,b,c,d,e){a.$state=b,a.$stateParams=c,e.debugUiRouter&&(a.$on("$stateChangeStart",function(a,b,c){d.log("$stateChangeStart to "+b.to+"- fired when the transition begins. toState,toParams : \n",b,c)}),a.$on("$stateChangeError",function(){d.log("$stateChangeError - fired when an error occurs during transition."),d.log(arguments)}),a.$on("$stateChangeSuccess",function(a,b){d.log("$stateChangeSuccess to "+b.name+"- fired once the state transition is complete.")}),a.$on("$viewContentLoaded",function(a){d.log("$viewContentLoaded - fired after dom rendered",a)}),a.$on("$stateNotFound",function(a,b,c,e){d.log("$stateNotFound "+b.to+"  - fired when a state cannot be found by its name."),d.log(b,c,e)}))}]),angular.module("config",[]).constant("Config",{backend:"http://live-productivity.pantheon.io",debugUiRouter:!1}).value("debug",!0),angular.module("clientApp").controller("HomepageCtrl",["$scope","$state","account","$log",function(a,b,c){if(c){var d=new Date,e=d.getDate(),f=d.getMonth()+1,g=d.getFullYear();b.go("dashboard.tracking-form",{username:c.label,year:g,month:f,day:e,id:"new"})}else b.go("login")}]),angular.module("clientApp").controller("AccountCtrl",["$scope","account",function(a,b){a.account=b}]),angular.module("clientApp").controller("TrackingCtrl",["$scope","tracking","$stateParams","$log",function(a,b,c){function d(){var a=d3.select(this).node().parentNode;d3.select(a).selectAll("circle").style("display","none"),d3.select(a).selectAll("text.value").style("display","block")}function e(){var a=d3.select(this).node().parentNode;d3.select(a).select("text").style("display","none"),d3.select(a).select("text.value").style("display","block")}function f(){var a=d3.select(this).node().parentNode;d3.select(a).selectAll("circle").style("display","block"),d3.select(a).selectAll("text.value").style("display","none")}function g(a){var b={};return angular.forEach(a,function(a){void 0==a.employee&&("regular"==a.type&&(a.employee=a.projectName),a.employee=a.type),void 0==b[a.employee]&&(b[a.employee]=[]),"day"==a.length.period&&(a.length.interval=8*parseInt(a.length.interval)),"regular"!=a.type&&(a.projectName=a.type,a.length.interval=8),void 0==b[a.employee]&&(b[a.employee]=[]),b[a.employee].push([a.day,a.length.interval,a.projectName,a.type])}),b}a.tracking=b,a.selectedTrack=null,a.year=c.year,a.month=c.month;var h=1024,i=1,j=30,k=d3.scale.category20c(),l=d3.scale.linear().range([0,h]),m=d3.svg.axis().scale(l).orient("top"),n=d3.select(".tracking-data");l.domain([i,j]);var o=d3.scale.linear().domain([i,j]).range([0,h]);n.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(m);var p=g(b),q=0;angular.forEach(p,function(a,b){var c=n.append("g").attr("class","journal"),g=c.selectAll("circle").data(a).enter().append("circle"),i=c.selectAll("text").data(a).enter().append("text"),j=c.selectAll("button").data(a).enter().append("text").on("mouseover",e).on("mouseout",f),l=d3.scale.linear().domain([0,d3.max(a,function(a){return a[1]})]).range([2,9]);g.attr("cx",function(a){return o(a[0])}).attr("cy",20*q+20).attr("r",function(a){return l(a[1])}).attr("class",function(a){return a[3]}).attr("data-toggle","tooltip").attr("data-placement","top").attr("title",function(a){return a[2]}),j.attr("y",20*q+25).attr("x",function(a){return o(a[0])-5}).attr("data-toggle","tooltip").attr("data-placement","top").style("display","none").text(function(a){return a[2]}).attr("title",function(a){return a[2]}),i.attr("y",20*q+25).attr("x",function(a){return o(a[0])-5}).attr("class","value").text(function(a){return a[1]}).style("fill",function(){return k(q)}).style("display","none"),c.append("text").attr("y",20*q+25).attr("x",h+20).attr("class","label").text(b).style("fill",function(){return k(q)}).on("mouseover",d).on("mouseout",f),q++}),$(function(){$('[data-toggle="tooltip"]').tooltip()});var r=function(b){a.selectedTrack=null,angular.forEach(a.tracking,function(c){c.id==b&&(a.selectedTrack=c)})};c.trackId&&r(c.trackId)}]),angular.module("clientApp").controller("TrackingFormCtrl",["$scope","$stateParams","$state","$log","projects","Tracking","tracking","Config",function(a,b,c,d,e,f,g,h){a.tracking=g,h.debug&&console.log(g);var i=new Date(b.year,b.month,0).getDate();a.days=[];for(var j=1;i>=j;j++)a.days.push(j);var k=["January","February","March","April","May","June","July","August","September","October","November","December"];a.month=b.month,a.monthString=k[a.month-1],a.year=b.year,a.day=b.day,a.employee=b.username,a.nextMonth=a.month+1,a.nextYear=a.year,a.prevMonth=a.month-1,a.prevYear=a.year,12==a.month&&(a.nextMonth=1,a.nextYear=a.year+1),1==a.month&&(a.prevMonth=12,a.prevYear=a.year-1),a.creating=!1,a.projects=e,a.message="",a.messageClass="alert-success","new"==b.id||"undefined"==b.id?(a.title="What have you done on the "+b.day+"/"+b.month+"/"+b.year+" ?",a.data={},a.data.period="hour",a.data.type="regular",a.data.employee=b.username):(a.title="Your report for the "+b.day+"/"+b.month+"/"+b.year+" ?",angular.forEach(g[b.day],function(c){c.id==b.id&&(a.data=c)})),a.save=function(d){a.creating=!0;var e=b.year+"-"+b.month+"-"+b.day;d.date=new Date(e).getTime()/1e3,h.debug&&console.log(d),f.save(d).then(function(d){if(a.creating=!1,d.error)return a.messageClass="alert-danger",void(a.message="Error Saving.");if(a.messageClass="alert-success",a.message="Saved successfully.",0==d.data[0].status)return void c.go("dashboard.tracking-form",{username:b.username,year:b.year,month:b.month,day:b.day,id:"new"},{reload:!0});var e=d.data[0];e["new"]&&(g[e.day].push(e),b.id=e.id),c.go("dashboard.tracking-form",{username:e.employee,year:b.year,month:b.month,day:e.day,id:e.id},{reload:!0})})},a.owner=function(a){return a.id&&b.username==a.employee},a.remove=function(c){return b.username!=c.employee?!1:(c.status=0,void a.save(c))}}]),angular.module("clientApp").controller("TrackingTableCtrl",["$scope","tracking","trackingProject","$stateParams","$log","Config",function(a,b,c,d,e,f){console.log(c);for(var g=new Date(d.year,d.month,0).getDate(),h=[],i=1;g>=i;i++)h.push(i);a.trackingProject=c,a.employeeRows=b,a.year=d.year,a.month=d.month,a.nextMonth=a.month+1,a.nextYear=a.year,a.prevMonth=a.month-1,a.prevYear=a.year,12===a.month&&(a.nextMonth=1,a.nextYear=a.year+1),1===a.month&&(a.prevMonth=12,a.prevYear=a.year-1),a.days=h,f.debug&&console.log(a.employeeRows)}]),angular.module("clientApp").controller("LoginCtrl",["$scope","Auth","$state",function(a,b,c){a.loginButtonEnabled=!0,a.loginFailed=!1,a.login=function(d){a.loginButtonEnabled=!1,b.login(d).then(function(){c.go("homepage")},function(){a.loginButtonEnabled=!0,a.loginFailed=!0})}}]),angular.module("clientApp").controller("DashboardCtrl",["$scope","Auth","$state","account","$log",function(a,b,c,d){var e=new Date;a.day=e.getDate(),a.month=e.getMonth()+1,a.year=e.getFullYear(),a.employee=d.label,a.logout=function(){b.logout(),c.go("login")}}]),angular.module("clientApp").service("Account",["$q","$http","$timeout","Config","$rootScope","$log",function(a,b,c,d,e){function f(){var c=a.defer(),e=d.backend+"/api/me/";return b({method:"GET",url:e,transformResponse:g}).success(function(a){j(a[0]),c.resolve(a[0])}),c.promise}function g(a){return(a=angular.fromJson(a).data)?(angular.forEach(a[0].companies,function(b,c){a[0].companies[c].id=parseInt(b.id)}),a):void 0}var h={},i="ProductivityAccountChange";this.get=function(){return a.when(h.data||f())};var j=function(a){h={data:a,timestamp:new Date},c(function(){h={}},6e4),e.$broadcast(i)};e.$on("clearCache",function(){h={}})}]),angular.module("clientApp").service("Auth",["$injector","$rootScope","Utils","localStorageService","Config",function(a,b,c,d,e){this.login=function(b){return a.get("$http")({method:"GET",url:e.backend+"/api/login-token",headers:{Authorization:"Basic "+c.Base64.encode(b.username+":"+b.password)}})},this.logout=function(){d.remove("access_token"),b.$broadcast("clearCache"),a.get("$state").go("login")},this.isAuthenticated=function(){return!!d.get("access_token")},this.authFailed=function(){this.logout()}}]),angular.module("clientApp").service("Utils",function(){var a=this;this.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(b){var c,d,e,f,g,h,i,j="",k=0;for(b=a.Base64._utf8_encode(b);k<b.length;)c=b.charCodeAt(k++),d=b.charCodeAt(k++),e=b.charCodeAt(k++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),j=j+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h)+this._keyStr.charAt(i);return j},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}}}),angular.module("clientApp").service("Tracking",["$q","$http","$timeout","Config","$rootScope","localStorageService",function(a,b,c,d,e){var f={};this.get=function(b,c,d){return a.when(f.data||g(b,c,d))},this.save=function(c){var e=a.defer(),f=d.backend+"/api/tracking",g="POST";return c.id&&(g="PATCH",f+="/"+c.id),d.debug&&(f+="?XDEBUG_SESSION_START=13261"),b({method:g,url:f,data:c}).success(function(a){a.error=!1,e.resolve(a)}).error(function(a){a.error=!0,e.resolve(a)}),e.promise};var g=function(c,e,f){var g=a.defer(),h=d.backend+"/api/tracking?year="+c+"&month="+e;return void 0!=f&&(h+="&employee="+f),d.debug&&(h+="&XDEBUG_SESSION_START=13261"),b({method:"GET",url:h}).success(function(a){g.resolve(a.data)}),g.promise};e.$on("clearCache",function(){f={}})}]),angular.module("clientApp").service("TrackingProject",["$q","$http","$timeout","Config","$rootScope","localStorageService",function(a,b,c,d,e){var f={},g="ProductivityTrackingProjectChange";this.get=function(b,c){return a.when(f.data||h(b,c))};var h=function(c,e){var f=a.defer(),g=d.backend+"/api/tracking-project?year="+c+"&month="+e;return console.log(g),d.debug&&(g+="&XDEBUG_SESSION_START=14241"),b({method:"GET",url:g}).success(function(a){i(a.data),f.resolve(a.data)}),f.promise},i=function(a){f={data:a,timestamp:new Date},c(function(){f={}},6e4),e.$broadcast(g)};e.$on("clearCache",function(){f={}})}]),angular.module("clientApp").service("Projects",["$q","$http","$timeout","Config","$rootScope","localStorageService",function(a,b,c,d,e){var f={},g="ProductivityProjectsChange";this.get=function(b,c){return a.when(f.data||h(b,c))},this.save=function(c){var e=a.defer(),f=d.backend+"/api/projects";return b({method:"POST",url:f,data:c}).success(function(){}),e.promise};var h=function(c,e){var f=a.defer(),g={sort:"label",year:c,month:e},h=d.backend+"/api/projects";return b({method:"GET",url:h,params:g}).success(function(a){i(a.data),f.resolve(a.data)}),f.promise},i=function(a){f={data:a,timestamp:new Date},c(function(){f={}},6e4),e.$broadcast(g)};e.$on("clearCache",function(){f={}})}]),angular.module("clientApp").directive("spinner",function(){return{template:'<div class="spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>',restrict:"E"}});